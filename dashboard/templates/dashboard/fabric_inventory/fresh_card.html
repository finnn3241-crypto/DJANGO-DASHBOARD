{% load humanize %}

<style>
body { margin:0; padding:0; background:#f5f6f8; font-family: 'IBM Plex Sans', system-ui, sans-serif;  }

.fabric-row{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
    gap:24px;
    padding:20px;
}

/* MAIN CARD */
.freshCard{
    background:#eceef1;
    border-radius:16px;
    box-shadow:0 6px 14px rgba(0,0,0,.12);
    overflow:hidden;
    border:1px solid #d8dbe0;
    display:flex;
    flex-direction:column;
}

/* CARD HEADER */
.freshHeader{
    background:#8fbc8f;
    color:#000;
    text-align:center;
    padding:12px;
    font-weight:700;
    font-size:25px;
    letter-spacing:.8px;
    text-transform:uppercase;
}

/* BODY */
.freshBody{ padding:16px; }

/* CHART */
.freshChartContainer{ text-align:center; margin-bottom:12px; }
.freshChartText{ font-weight:700; font-size:16px; margin-top:8px; }
.freshChartSubText{ font-size:14px; color:#2d2d2d; }

/* STORE / SECTION BOX */
.sectionBox{
    background:#fff;
    border-radius:16px;
    padding:12px;
    margin-top:14px;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
    border:1px solid #eee;
}

/* SECTION HEADER */
.sectionTitle{
    text-align:center;
    font-weight:800;
    font-size:14px;
    padding:6px 10px;
    border-radius:12px;
    margin:0 auto 10px;
    width:max-content;
    letter-spacing:.6px;
}

.grade{ background:#82d9f3; }
.manager{ background:#ff9065; }
.aging{ background:#86ef8e; }

/* ROWS */
.rowBlock{ margin-bottom:10px; }
.rowTop{
    display:flex;
    justify-content:space-between;
    font-size:16px;
    text-transform:uppercase;
}
.rowLabel{ font-weight:500; }
.rowValue{ font-weight:500; }

/* PROGRESS BARS */
.bar-outer{
    width:100%;
    height:14px;
    background:#e5e7eb;
    border-radius:999px;
    overflow:hidden;
    position:relative;
    margin-top:4px;
}
.bar-inner{
    height:100%;
    border-radius:999px;
    transition:width .7s ease;
}
.bar-text{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:11px;
    font-weight:600;
}
.empty-bar-inner {
        height: 100%;
        background: none;
        border-radius: 10px;
}

.empty-bar-outer {
        width: 100%;
        height: 13px;
        background: none;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        margin-top: 3px;
}
/* TABLE */
table{ font-size:16px; margin-bottom:6px; }
.freshLabelCell{ text-transform:uppercase; }
.freshValueCell{ text-align:right; }

/* CANVAS SIZE */
canvas{ width:96px !important; height:96px !important; margin:auto; }
</style>

<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<div class="fabric-row">
<div class="freshCard">
<div class="freshHeader">FRESH</div>

<div class="freshBody">

<div class="freshChartContainer">
    <canvas id="freshProgressChart"></canvas>
    <div class="freshChartText">{{ fresh.overall_pct }}% of Overall Inventory</div>
    <div class="freshChartSubText">
        (Inventory: {{ fresh.total|intcomma }} / Meter: {{ kpi_meter|intcomma }})
    </div>
</div>

<table width="100%">
<tr><td class="freshLabelCell">Open :</td><td class="freshValueCell">{{ fresh.open|intcomma }}</td></tr>
<tr><td colspan="2"><div class="bar-outer"><div class="bar-inner" style="width:{{ fresh.pct_open }}%;background:#4caf50;"></div><div class="bar-text">{{ fresh.pct_open }}%</div></div></td></tr>

<tr><td class="freshLabelCell">Close :</td><td class="freshValueCell">{{ fresh.close|intcomma }}</td></tr>
<tr><td colspan="2"><div class="bar-outer"><div class="bar-inner" style="width:{{ fresh.pct_close }}%;background:#2196f3;"></div><div class="bar-text">{{ fresh.pct_close }}%</div></div></td></tr>

<tr><td class="freshLabelCell">Cancel :</td><td class="freshValueCell">{{ fresh.cancel|intcomma }}</td></tr>
<tr><td colspan="2"><div class="bar-outer"><div class="bar-inner" style="width:{{ fresh.pct_cancel }}%;background:#ff9510;"></div><div class="bar-text">{{ fresh.pct_cancel }}%</div></div></td></tr>

<tr><td class="freshLabelCell">RFAN :</td><td class="freshValueCell">{{ fresh.rfan|intcomma }}</td></tr>
<tr><td colspan="2"><div class="bar-outer"><div class="bar-inner" style="width:{{ fresh.pct_rfan }}%;background:#e91e63;"></div><div class="bar-text">{{ fresh.pct_rfan }}%</div></div></td></tr>

<tr><td class="freshLabelCell"><b>Total :</b></td><td class="freshValueCell"><b>{{ fresh.total|intcomma }}</b></td></tr>
</table>

<div class="sectionBox">
<div class="sectionTitle grade">GRADE WISE</div>
{% for g in fresh_grade_list %}
<div class="rowBlock">
<div class="rowTop"><div class="rowLabel">{{ g.grade }}</div><div class="rowValue">{{ g.value|intcomma }}</div></div>
<div class="rowBar"><div class="bar-outer"><div class="bar-inner" style="width:{{ g.pct }}%;background:#4caf50;"></div><div class="bar-text">{{ g.pct }}%</div></div></div>
</div>
{% endfor %}
</div>

<div class="sectionBox">
<div class="sectionTitle manager">MANAGER WISE</div>
{% for m in fresh_manager_list %}
<div class="rowBlock">
<div class="rowTop"><div class="rowLabel">{{ m.manager }}</div><div class="rowValue">{{ m.value|intcomma }}</div></div>
<div class="rowBar"><div class="bar-outer"><div class="bar-inner" style="width:{{ m.pct }}%;background:#2196f3;"></div><div class="bar-text">{{ m.pct }}%</div></div></div>
</div>
{% endfor %}
</div>

<div class="sectionBox">
<div class="sectionTitle aging">AGING WISE</div>
{% for a in fresh_aging_list %}
<div class="rowBlock">
<div class="rowTop"><div class="rowLabel">{{ a.age }}</div><div class="rowValue">{{ a.value|intcomma }}</div></div>
<div class="rowBar"><div class="bar-outer"><div class="bar-inner" style="width:{{ a.pct }}%;background:#ff9510;"></div><div class="bar-text">{{ a.pct }}%</div></div></div>
</div>
{% endfor %}
</div>

</div>
</div>

{% comment %} STOCK {% endcomment %}
<div class="freshCard">
<div class="freshHeader">STOCK</div>

<div class="freshBody">

<div class="freshChartContainer">
    <canvas id="stockProgressChart"></canvas>
    <div class="freshChartText">{{ stock.overall_pct }}% of Overall Inventory</div>
    <div class="freshChartSubText">
        (Inventory: {{ stock.total|intcomma }} / Meter: {{ kpi_meter|intcomma }})
    </div>
</div>

<table width="100%">
<tr><td class="freshLabelCell">Fresh :</td><td class="freshValueCell">{{ stock.fresh|intcomma }}</td></tr>
<tr><td colspan="2"><div class="bar-outer"><div class="bar-inner" style="width:{{ stock.pct_fresh }}%;background:#4caf50;"></div><div class="bar-text">{{ stock.pct_fresh }}%</div></div></td></tr>

<tr><td class="freshLabelCell">Others :</td><td class="freshValueCell">{{ stock.others|intcomma }}</td></tr>
<tr><td colspan="2"><div class="bar-outer"><div class="bar-inner" style="width:{{ stock.pct_others }}%;background:#2196f3;"></div><div class="bar-text">{{ stock.pct_others }}%</div></div></td></tr>

<tr><td class="freshLabelCell">Total :</td><td class="freshValueCell">{{ stock.total|intcomma }}</td></tr>
<tr><td colspan="2"><div class="bar-outer"><div class="bar-inner" style="width:{{ stock.pct_cancel }}"></div><div class="bar-text">{{ stock.pct_cancel }}%</div></div></td></tr>

<tr><td class="freshLabelCell">Soldout :</td><td class="freshValueCell">{{ stock.sold|intcomma }}</td></tr>
<tr><td colspan="2"><div class="bar-outer"><div class="bar-inner" style="width:{{ stock.pct_sold }}%;background:#e91e63;"></div><div class="bar-text">{{ stock.pct_sold }}%</div></div></td></tr>

<tr><td class="freshLabelCell"><b>Net :</b></td><td class="freshValueCell"><b>{{ stock.net|intcomma }}</b></td></tr>
</table>

<div class="sectionBox">
<div class="sectionTitle grade">GRADE WISE</div>
{% for g in stock_grade_list %}
<div class="rowBlock">
    <div class="rowTop">
        <div class="rowLabel">{{ g.grade }}</div>
        <div class="rowValue">{{ g.value|intcomma }}</div>
    </div>
    <div class="rowBar">
        <div class="bar-outer">
            <div class="bar-inner" style="width:{{ g.pct }}%;background:#4caf50;"></div>
            <div class="bar-text">{{ g.pct }}%</div>
        </div>
    </div>
</div>
{% endfor %}
</div>


<div class="sectionBox">
<div class="sectionTitle manager">MANAGER WISE</div>
{% for m in stock_manager_list %}
<div class="rowBlock">
    <div class="rowTop">
        <div class="rowLabel">{{ m.manager }}</div>
        <div class="rowValue">{{ m.value|intcomma }}</div>
    </div>
    <div class="rowBar">
        <div class="bar-outer">
            <div class="bar-inner" style="width:{{ m.pct }}%;background:#2196f3;"></div>
            <div class="bar-text">{{ m.pct }}%</div>
        </div>
    </div>
</div>
{% endfor %}
</div>


<div class="sectionBox">
<div class="sectionTitle aging">AGING WISE</div>
{% for a in stock_aging_list %}
<div class="rowBlock">
    <div class="rowTop">
        <div class="rowLabel">{{ a.age }}</div>
        <div class="rowValue">{{ a.value|intcomma }}</div>
    </div>
    <div class="rowBar">
        <div class="bar-outer">
            <div class="bar-inner" style="width:{{ a.pct }}%;background:#ff9510;"></div>
            <div class="bar-text">{{ a.pct }}%</div>
        </div>
    </div>
</div>
{% endfor %}
</div>


</div>
</div>

{% comment %} SAMPLE {% endcomment %}
<div class="freshCard">
<div class="freshHeader">SAMPLE</div>

<div class="freshBody">

<div class="freshChartContainer">
    <canvas id="sampleProgressChart"></canvas>
    <div class="freshChartText">{{ sample.overall_pct }}% of Overall Inventory</div>
    <div class="freshChartSubText">
        (Inventory: {{ sample.sample|intcomma }} / Meter: {{ kpi_meter|intcomma }})
    </div>
</div>

<table width="100%">
<tr><td class="freshLabelCell">Sample :</td><td class="freshValueCell">{{ sample.sample|intcomma }}</td></tr>
<tr><td colspan="2"><div class="bar-outer"><div class="bar-inner" style="width:100%; background:#4caf50;"></div><div class="bar-text">100%</div></div></td></tr>

<tr><td class="freshLabelCell">&nbsp;</td><td class="freshValueCell">&nbsp;</td></tr>
<tr><td colspan="2"><div class="empty-bar-outer"><div class="empty-bar-inner" style="width:{{ sample.pct_close }}"></div><div class="bar-text">&nbsp;</div></div></td></tr>

<tr><td class="freshLabelCell">&nbsp;</td><td class="freshValueCell">&nbsp;</td></tr>
<tr><td colspan="2"><div class="empty-bar-outer"><div class="empty-bar-inner" style="width:{{ sample.pct_cancel }}"></div><div class="bar-text">&nbsp;</div></div></td></tr>

<tr><td class="freshLabelCell">&nbsp;</td><td class="freshValueCell">&nbsp;</td></tr>
<tr><td colspan="2"><div class="empty-bar-outer"><div class="empty-bar-inner" style="width:{{ sample.pct_rfan }}"></div><div class="bar-text">&nbsp;</div></div></td></tr>

<tr><td class="freshLabelCell">&nbsp;<b></b></td><td class="freshValueCell"><b>&nbsp;</b></td></tr>
</table>

<div class="sectionBox">
<div class="sectionTitle grade">GRADE WISE</div>
{% for g in sample_grade_list %}
<div class="rowBlock">
    <div class="rowTop">
        <div class="rowLabel">{{ g.grade }}</div>
        <div class="rowValue">{{ g.value|intcomma }}</div>
    </div>
    <div class="rowBar">
        <div class="bar-outer">
            <div class="bar-inner" style="width:{{ g.pct }}%;background:#4caf50;"></div>
            <div class="bar-text">{{ g.pct }}%</div>
        </div>
    </div>
</div>
{% endfor %}

</div>

<div class="sectionBox">
<div class="sectionTitle manager">MANAGER WISE</div>
{% for m in sample_manager_list %}
<div class="rowBlock">
    <div class="rowTop">
        <div class="rowLabel">{{ m.manager }}</div>
        <div class="rowValue">{{ m.value|intcomma }}</div>
    </div>
    <div class="rowBar">
        <div class="bar-outer">
            <div class="bar-inner" style="width:{{ m.pct }}%;background:#2196f3;"></div>
            <div class="bar-text">{{ m.pct }}%</div>
        </div>
    </div>
</div>
{% endfor %}

</div>

<div class="sectionBox">
<div class="sectionTitle aging">AGING WISE</div>
{% for a in sample_aging_list %}
<div class="rowBlock">
    <div class="rowTop">
        <div class="rowLabel">{{ a.age }}</div>
        <div class="rowValue">{{ a.value|intcomma }}</div>
    </div>
    <div class="rowBar">
        <div class="bar-outer">
            <div class="bar-inner" style="width:{{ a.pct }}%;background:#ff9510;"></div>
            <div class="bar-text">{{ a.pct }}%</div>
        </div>
    </div>
</div>
{% endfor %}
</div>

</div>
</div>

{% comment %} RETURN {% endcomment %}
<div class="freshCard">
<div class="freshHeader">RETURN</div>

<div class="freshBody">

<div class="freshChartContainer">
    <canvas id="returnProgressChart"></canvas>
    <div class="freshChartText">{{ sr.overall_pct }}% of Overall Inventory</div>
    <div class="freshChartSubText">
        (Inventory: {{ sr.sales_return|intcomma }} / Meter: {{ kpi_meter|intcomma }})
    </div>
</div>

<table width="100%">
<tr><td class="freshLabelCell">Return :</td><td class="freshValueCell">{{ sr.sales_return|intcomma }}</td></tr>
<tr><td colspan="2"><div class="bar-outer"><div class="bar-inner" style="width:100%; background:#4caf50;"></div><div class="bar-text">100%</div></div></td></tr>

<tr><td class="freshLabelCell">&nbsp;</td><td class="freshValueCell">&nbsp;</td></tr>
<tr><td colspan="2"><div class="empty-bar-outer"><div class="empty-bar-inner" style="width:{{ sample.pct_close }}"></div><div class="bar-text">&nbsp;</div></div></td></tr>

<tr><td class="freshLabelCell">&nbsp;</td><td class="freshValueCell">&nbsp;</td></tr>
<tr><td colspan="2"><div class="empty-bar-outer"><div class="empty-bar-inner" style="width:{{ sample.pct_cancel }}"></div><div class="bar-text">&nbsp;</div></div></td></tr>

<tr><td class="freshLabelCell">&nbsp;</td><td class="freshValueCell">&nbsp;</td></tr>
<tr><td colspan="2"><div class="empty-bar-outer"><div class="empty-bar-inner" style="width:{{ sample.pct_rfan }}"></div><div class="bar-text">&nbsp;</div></div></td></tr>

<tr><td class="freshLabelCell">&nbsp;<b></b></td><td class="freshValueCell"><b>&nbsp;</b></td></tr>
</table>

<div class="sectionBox">
<div class="sectionTitle grade">GRADE WISE</div>
{% for g in sales_return_grade_list %}
<div class="rowBlock">
    <div class="rowTop">
        <div class="rowLabel">{{ g.grade }}</div>
        <div class="rowValue">{{ g.value|intcomma }}</div>
    </div>
    <div class="rowBar">
        <div class="bar-outer">
            <div class="bar-inner" style="width:{{ g.pct }}%;background:#4caf50;"></div>
            <div class="bar-text">{{ g.pct }}%</div>
        </div>
    </div>
</div>
{% endfor %}

</div>

<div class="sectionBox">
<div class="sectionTitle manager">MANAGER WISE</div>
{% for m in sales_return_manager_list %}
<div class="rowBlock">
    <div class="rowTop">
        <div class="rowLabel">{{ m.manager }}</div>
        <div class="rowValue">{{ m.value|intcomma }}</div>
    </div>
    <div class="rowBar">
        <div class="bar-outer">
            <div class="bar-inner" style="width:{{ m.pct }}%;background:#2196f3;"></div>
            <div class="bar-text">{{ m.pct }}%</div>
        </div>
    </div>
</div>
{% endfor %}

</div>

<div class="sectionBox">
<div class="sectionTitle aging">AGING WISE</div>
{% for a in sales_return_aging_list %}
<div class="rowBlock">
    <div class="rowTop">
        <div class="rowLabel">{{ a.age }}</div>
        <div class="rowValue">{{ a.value|intcomma }}</div>
    </div>
    <div class="rowBar">
        <div class="bar-outer">
            <div class="bar-inner" style="width:{{ a.pct }}%;background:#ff9510;"></div>
            <div class="bar-text">{{ a.pct }}%</div>
        </div>
    </div>
</div>
{% endfor %}
</div>

</div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    function buildChart(canvasId, inventory, total) {
        const el = document.getElementById(canvasId);
        if (!el) return;

        inventory = Number(inventory) || 0;
        total = Number(total) || 0;

        const remaining = Math.max(total - inventory, 0);

        new Chart(el, {
            type: "doughnut",
            data: {
                datasets: [{
                    data: [inventory, remaining],
                    backgroundColor: ["#4caf50", "#e0e0e0"],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                cutout: "72%",
                plugins: { legend: { display: false } }
            }
        });
    }

    buildChart(
        "freshProgressChart",
        {{ fresh.total|default:0 }},
        {{ kpi_meter|default:0 }}
    );

    buildChart(
        "stockProgressChart",
        {{ stock.total|default:0 }},
        {{ kpi_meter|default:0 }}
    );

    buildChart(
        "sampleProgressChart",
        {{ sample.sample|default:0 }},
        {{ kpi_meter|default:0 }}
    );

    buildChart(
        "returnProgressChart",
        {{ sr.sales_return|default:0 }},
        {{ kpi_meter|default:0 }}
    );

});
</script>

